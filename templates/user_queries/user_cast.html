{% extends "base.html" %}

{% block title %}Cast Search - User Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <a href="{{ url_for('user_home') }}" class="btn btn-outline-secondary mb-2">
            <i class="bi bi-arrow-left"></i> Back to Home
        </a>
        <h1 class="mb-3"><i class="bi bi-people"></i> Search by Actor</h1>
        <p class="text-muted mb-0">Find movies featuring your favorite actors.</p>
    </div>
</div>

<!-- Search Box -->
<div class="card mb-4">
    <div class="card-body">
        <div class="input-group">
            <input type="text" class="form-control" name="search" id="actor-search-input"
                   placeholder="Enter actor name..."
                   value="{{ search_query }}">
            <button class="btn btn-primary" id="actor-search-btn" type="button">
                <i class="bi bi-search"></i> Search
            </button>
            {% if search_query %}
            <a href="{{ url_for('user_cast') }}" class="btn btn-outline-secondary">
                <i class="bi bi-x"></i> Clear
            </a>
            {% endif %}
        </div>
        <small class="text-muted d-block mt-2" id="search-status">
            {% if search_query %}Showing results for "{{ search_query }}"{% else %}Start typing to search by actor{% endif %}
        </small>
    </div>
</div>

<div id="results-container" class="{% if not search_query %}d-none{% endif %}">
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Movie ID</th>
                        <th>Title</th>
                        <th>Release Date</th>
                        <th>Character</th>
                        <th>Average Rating</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="no-results" class="text-center py-5 d-none">
    <i class="bi bi-emoji-frown display-4 text-muted"></i>
    <p class="lead mt-3">No movies found for that actor.</p>
    <p class="text-muted mb-0">Try adjusting the name or searching for another actor.</p>
</div>
</div>

<div id="empty-state" class="alert alert-info {% if search_query %}d-none{% endif %}">
    <i class="bi bi-info-circle"></i> Start by entering an actor name to see matching movies.
</div>

<script>
    (function() {
        const input = document.getElementById('actor-search-input');
        const btn = document.getElementById('actor-search-btn');
        const statusEl = document.getElementById('search-status');
        const resultsBody = document.getElementById('results-body');
        const resultsContainer = document.getElementById('results-container');
        const noResults = document.getElementById('no-results');
        const emptyState = document.getElementById('empty-state');
        const movieDetailBase = "{{ url_for('user_view_movie', movie_id=0) }}";

        const initialData = {{ movies|default([], true)|tojson|safe }};
        if (initialData.length) {
            renderResults(initialData);
            resultsContainer.classList.remove('d-none');
            emptyState.classList.add('d-none');
        }

        let debounceTimer;
        function debounce(fn, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function renderResults(data) {
            resultsBody.innerHTML = '';
            if (!data || !data.length) {
                noResults.classList.remove('d-none');
                resultsContainer.classList.add('d-none');
                return;
            }

            noResults.classList.add('d-none');
            resultsContainer.classList.remove('d-none');

            data.forEach(movie => {
                const detailHref = movie.movie_id ? movieDetailBase.replace(/0$/, movie.movie_id) : '#';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${movie.movie_id}</td>
                    <td>
                        <a href="${detailHref}"
                           class="text-decoration-none fw-semibold">
                            ${movie.title || 'Untitled'}
                        </a>
                    </td>
                    <td>${movie.released_date || 'N/A'}</td>
                    <td><em>${movie.character || 'N/A'}</em></td>
                    <td>${movie.avg_rating ? `<span class="badge bg-success"><i class="bi bi-star-fill"></i> ${Number(movie.avg_rating).toFixed(1)}</span>` : '<small class="text-muted">N/A</small>'}</td>
                `;
                resultsBody.appendChild(tr);
            });
        }

        async function performSearch() {
            const query = input.value.trim();
            if (!query) {
                statusEl.textContent = 'Start typing to search by actor';
                resultsBody.innerHTML = '';
                resultsContainer.classList.add('d-none');
                noResults.classList.add('d-none');
                emptyState.classList.remove('d-none');
                return;
            }

            statusEl.textContent = `Searching for "${query}"...`;
            emptyState.classList.add('d-none');
            try {
                const resp = await fetch(`{{ url_for('api_user_cast') }}?search=${encodeURIComponent(query)}`);
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                statusEl.textContent = `Showing ${data.movies.length} result(s) for "${query}"`;
                renderResults(data.movies);
            } catch (err) {
                statusEl.textContent = `Error: ${err.message}`;
                resultsBody.innerHTML = '';
                resultsContainer.classList.add('d-none');
                noResults.classList.remove('d-none');
            }
        }

        const debouncedSearch = debounce(performSearch, 300);
        input.addEventListener('input', debouncedSearch);
        btn.addEventListener('click', performSearch);
    })();
</script>
{% endblock %}
