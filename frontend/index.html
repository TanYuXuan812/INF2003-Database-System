<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Database - User Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        header p {
            opacity: 0.9;
        }
        nav {
            background: #4a5568;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        nav a:hover {
            background: #2d3748;
        }
        .content {
            padding: 30px;
        }
        .search-section {
            margin-bottom: 30px;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"], select {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .card p {
            color: #4a5568;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .card .rating {
            color: #f6ad55;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #4a5568;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .info-box {
            background: #bee3f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .stat-card p {
            opacity: 0.9;
        }
        footer {
            background: #2d3748;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ Movie Database</h1>
            <p>INF2003 Dual-Database System</p>
            <p style="font-size: 0.9em; margin-top: 10px;">PostgreSQL + MongoDB | User Portal</p>
        </header>

        <nav>
            <div>
                <a href="/">Home</a>
                <a href="#search">Search Movies</a>
                <a href="#trending">Trending</a>
                <a href="#compare">Compare DB</a>
            </div>
            <a href="/admin/">Admin Portal ‚Üí</a>
        </nav>

        <div class="content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('search')">üîç Search Movies</button>
                <button class="tab" onclick="showTab('trending')">üî• Trending</button>
                <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
                <button class="tab" onclick="showTab('compare')">‚ö° Compare Databases</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-search" class="tab-content">
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search movies by title...">
                        <select id="genreFilter">
                            <option value="">All Genres</option>
                        </select>
                        <button onclick="searchMovies()">Search</button>
                    </div>
                </div>
                <div id="moviesGrid" class="grid"></div>
            </div>

            <div id="tab-trending" class="tab-content" style="display:none;">
                <h2 style="margin-bottom: 20px;">Trending Movies (MongoDB Analytics)</h2>
                <div id="trendingGrid" class="grid"></div>
            </div>

            <div id="tab-analytics" class="tab-content" style="display:none;">
                <h2 style="margin-bottom: 20px;">Real-Time Analytics</h2>
                <div class="stat-grid" id="statsGrid"></div>
                <h3 style="margin: 30px 0 20px 0;">Top Viewed Movies (Last 30 Days)</h3>
                <div id="topViewedGrid" class="grid"></div>
            </div>

            <div id="tab-compare" class="tab-content" style="display:none;">
                <h2 style="margin-bottom: 20px;">Database Performance Comparison</h2>
                <div class="info-box">
                    <h3 style="margin-bottom: 10px;">Compare SQL vs NoSQL Performance</h3>
                    <p>This demonstrates the same query executed on both PostgreSQL and MongoDB.</p>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="compareTopMovies()">Compare: Top Movies Query</button>
                    <button onclick="compareTrending()">Compare: Trending Calculation</button>
                </div>
                <div id="compareResults"></div>
            </div>
        </div>

        <footer>
            <p>INF2003 Database System Project | Advanced Database Features Demo</p>
            <p style="margin-top: 10px; font-size: 0.9em;">PostgreSQL: CTEs, Window Functions, Views, JSONB | MongoDB: Aggregation Pipelines, $facet, $lookup</p>
        </footer>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            event.target.classList.add('active');

            // Load data for tab
            if (tabName === 'trending') loadTrending();
            if (tabName === 'analytics') loadAnalytics();
        }

        // Search movies (SQL)
        async function searchMovies() {
            const search = document.getElementById('searchInput').value;
            const genre = document.getElementById('genreFilter').value;
            const grid = document.getElementById('moviesGrid');

            grid.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const params = new URLSearchParams({ search, genre, page: 1, page_size: 12 });
                const response = await fetch(`${API_BASE}/sql/movies?${params}`);
                const data = await response.json();

                if (data.data && data.data.length > 0) {
                    grid.innerHTML = data.data.map(movie => `
                        <div class="card">
                            <h3>${movie.title}</h3>
                            <p><strong>Released:</strong> ${movie.released_date || 'N/A'}</p>
                            <p><strong>Genres:</strong> ${movie.genres || 'N/A'}</p>
                            <p class="rating">‚≠ê ${Number(movie.avg_rating).toFixed(1)} (${movie.rating_count} ratings)</p>
                            <p><strong>Popularity:</strong> ${Number(movie.popularity).toFixed(1)}</p>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="loading">No movies found</div>';
                }
            } catch (error) {
                grid.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Load trending movies (MongoDB)
        async function loadTrending() {
            const grid = document.getElementById('trendingGrid');
            grid.innerHTML = '<div class="loading">Loading trending movies from MongoDB...</div>';

            try {
                const response = await fetch(`${API_BASE}/nosql/analytics/trending?days=7&limit=12`);
                const result = await response.json();

                if (result.data && result.data.length > 0) {
                    grid.innerHTML = result.data.map(item => `
                        <div class="card">
                            <h3>Movie ID: ${item.movie_id}</h3>
                            <p class="rating">üî• Trending Score: ${item.trending_score}</p>
                            <p><strong>Total Events:</strong> ${item.total_events}</p>
                            <p><strong>Unique Users:</strong> ${item.unique_user_count}</p>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="loading">No trending data available</div>';
                }
            } catch (error) {
                grid.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                // Get funnel data
                const funnelRes = await fetch(`${API_BASE}/nosql/analytics/funnel?days=30`);
                const funnelData = await funnelRes.json();

                const statsGrid = document.getElementById('statsGrid');
                if (funnelData.data) {
                    statsGrid.innerHTML = funnelData.data.map(item => `
                        <div class="stat-card">
                            <h3>${item.count}</h3>
                            <p>${item.event_type}</p>
                            <p style="font-size: 0.9em;">${item.unique_user_count} users</p>
                        </div>
                    `).join('');
                }

                // Get top viewed
                const viewedRes = await fetch(`${API_BASE}/nosql/analytics/top-viewed?days=30&limit=6`);
                const viewedData = await viewedRes.json();

                const viewedGrid = document.getElementById('topViewedGrid');
                if (viewedData.data) {
                    viewedGrid.innerHTML = viewedData.data.map(item => `
                        <div class="card">
                            <h3>Movie ID: ${item.movie_id}</h3>
                            <p class="rating">üëÅÔ∏è ${item.view_count} views</p>
                            <p><strong>Unique Viewers:</strong> ${item.unique_viewer_count}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('statsGrid').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Compare databases
        async function compareTopMovies() {
            const results = document.getElementById('compareResults');
            results.innerHTML = '<div class="loading">Running comparison...</div>';

            try {
                const response = await fetch(`${API_BASE}/compare/top-movies?limit=10&days=30`);
                const data = await response.json();

                results.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="info-box" style="background: #c6f6d5;">
                            <h3>PostgreSQL (SQL)</h3>
                            <p><strong>Time:</strong> ${data.sql.time_ms} ms</p>
                            <p><strong>Method:</strong> ${data.sql.method}</p>
                            <p><strong>Results:</strong> ${data.sql.row_count} rows</p>
                        </div>
                        <div class="info-box" style="background: #feebc8;">
                            <h3>MongoDB (NoSQL)</h3>
                            <p><strong>Time:</strong> ${data.nosql.time_ms} ms</p>
                            <p><strong>Method:</strong> ${data.nosql.method}</p>
                            <p><strong>Results:</strong> ${data.nosql.row_count} rows</p>
                        </div>
                    </div>
                    <div class="info-box">
                        <h3>Analysis</h3>
                        <p>${data.comparison.analysis}</p>
                        <p><strong>Faster:</strong> ${data.comparison.faster.toUpperCase()}</p>
                        <p><strong>Speedup:</strong> ${data.comparison.speedup_factor}x</p>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function compareTrending() {
            const results = document.getElementById('compareResults');
            results.innerHTML = '<div class="loading">Running comparison...</div>';

            try {
                const response = await fetch(`${API_BASE}/compare/trending?limit=10&days=7`);
                const data = await response.json();

                results.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="info-box" style="background: #c6f6d5;">
                            <h3>PostgreSQL (SQL)</h3>
                            <p><strong>Time:</strong> ${data.sql.time_ms} ms</p>
                            <p><strong>Method:</strong> ${data.sql.method}</p>
                        </div>
                        <div class="info-box" style="background: #feebc8;">
                            <h3>MongoDB (NoSQL)</h3>
                            <p><strong>Time:</strong> ${data.nosql.time_ms} ms</p>
                            <p><strong>Method:</strong> ${data.nosql.method}</p>
                        </div>
                    </div>
                    <div class="info-box">
                        <h3>Analysis</h3>
                        <p>${data.comparison.analysis}</p>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Load genres on page load
        async function loadGenres() {
            try {
                const response = await fetch(`${API_BASE}/sql/genres`);
                const genres = await response.json();
                const select = document.getElementById('genreFilter');
                genres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre.genre_name;
                    option.textContent = `${genre.genre_name} (${genre.movie_count})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading genres:', error);
            }
        }

        // Initialize
        loadGenres();
        searchMovies();
    </script>
</body>
</html>
